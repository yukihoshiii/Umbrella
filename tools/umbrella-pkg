#!/bin/bash
# Umbrella Package Manager (umbrella-pkg)

set -e

UMBRELLA_HOME="${HOME}/.umbrella"
PACKAGES_DIR="${UMBRELLA_HOME}/packages"
REGISTRY_URL="https://umbrella-registry.io"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Initialize umbrella home
init() {
    echo "Initializing Umbrella package manager..."
    mkdir -p "${PACKAGES_DIR}"
    echo "Created ${PACKAGES_DIR}"
}

# Install a package
install() {
    local package_name="$1"
    
    if [ -z "$package_name" ]; then
        # Install from package.json
        if [ ! -f "package.json" ]; then
            echo -e "${RED}Error: package.json not found${NC}"
            exit 1
        fi
        
        echo "Installing dependencies from package.json..."
        # Parse package.json and install each dependency
        # (simplified version)
        echo -e "${GREEN}Dependencies installed${NC}"
    else
        # Install specific package
        echo "Installing ${package_name}..."
        
        local package_dir="${PACKAGES_DIR}/${package_name}"
        mkdir -p "${package_dir}"
        
        # Download package (simplified - would use actual registry)
        echo "Downloading ${package_name}..."
        
        echo -e "${GREEN}${package_name} installed successfully${NC}"
    fi
}

# Remove a package
remove() {
    local package_name="$1"
    
    if [ -z "$package_name" ]; then
        echo -e "${RED}Error: Package name required${NC}"
        exit 1
    fi
    
    local package_dir="${PACKAGES_DIR}/${package_name}"
    
    if [ -d "$package_dir" ]; then
        rm -rf "$package_dir"
        echo -e "${GREEN}${package_name} removed${NC}"
    else
        echo -e "${YELLOW}Package ${package_name} not found${NC}"
    fi
}

# List installed packages
list() {
    echo "Installed packages:"
    if [ -d "$PACKAGES_DIR" ]; then
        ls -1 "$PACKAGES_DIR" 2>/dev/null || echo "  (none)"
    else
        echo "  (none)"
    fi
}

# Show package info
info() {
    local package_name="$1"
    
    if [ -z "$package_name" ]; then
        echo -e "${RED}Error: Package name required${NC}"
        exit 1
    fi
    
    echo "Package: ${package_name}"
    echo "Version: 1.0.0"
    echo "Description: Example package"
    echo "Author: Umbrella Community"
}

# Create new package
create() {
    local package_name="$1"
    
    if [ -z "$package_name" ]; then
        echo -e "${RED}Error: Package name required${NC}"
        exit 1
    fi
    
    mkdir -p "$package_name"
    cd "$package_name"
    
    # Create package.json
    cat > package.json << EOF
{
  "name": "${package_name}",
  "version": "1.0.0",
  "description": "A new Umbrella package",
  "main": "main.umb",
  "scripts": {
    "build": "umbrella main.umb -o ${package_name}",
    "test": "umbrella test/**/*.test.umb"
  },
  "dependencies": {},
  "author": "",
  "license": "MIT"
}
EOF
    
    # Create main.umb
    cat > main.umb << 'EOF'
function main(): number {
    println("Hello from ${package_name}!");
    return 0;
}
EOF
    
    echo -e "${GREEN}Created package ${package_name}${NC}"
    echo "  package.json"
    echo "  main.umb"
}

# Show help
help() {
    cat << EOF
Umbrella Package Manager

Usage: umbrella-pkg <command> [options]

Commands:
  init              Initialize package manager
  install [pkg]     Install package(s)
  remove <pkg>      Remove a package
  list              List installed packages
  info <pkg>        Show package information
  create <name>     Create new package
  help              Show this help message

Examples:
  umbrella-pkg install http
  umbrella-pkg install
  umbrella-pkg remove http
  umbrella-pkg list
  umbrella-pkg create my-app
EOF
}

# Main command dispatcher
case "$1" in
    init)
        init
        ;;
    install)
        install "$2"
        ;;
    remove)
        remove "$2"
        ;;
    list)
        list
        ;;
    info)
        info "$2"
        ;;
    create)
        create "$2"
        ;;
    help|--help|-h|"")
        help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'umbrella-pkg help' for usage"
        exit 1
        ;;
esac
